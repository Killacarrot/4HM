<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Four Horsemen Healer Rotation - Animated</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { box-sizing: border-box; }
        body { 
            margin: 0; 
            padding: 0; 
            background: #1e1b4b;
            min-height: 100vh;
        }
        
        html {
            background: #1e1b4b;
            min-height: 100vh;
        }
        
        #root {
            transform: scale(0.8);
            transform-origin: top left;
            width: 125%;
            height: 125%;
        }
        
        .healer-card {
            position: absolute;
            transition: all 1s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 50;
            pointer-events: none;
        }
        
        .healer-card.no-animation {
            transition: none;
        }

        .healer-card.moving {
            z-index: 200;
            transform: scale(1.15);
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.5));
            box-shadow: 0 0 20px 5px rgba(59, 130, 246, 0.6);
        }
        
        .grid-container {
            position: relative;
            overflow: visible !important;
        }
        
        .lg\:col-span-2 {
            overflow: visible !important;
        }
        
        /* Hide all scrollbars */
        .bg-green-900 {
            overflow: hidden !important;
        }
        
        .bg-green-900::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const React = window.React;
        const { useState, useEffect, useRef } = React;

        function FourHorsemenRotation() {
            const [healers, setHealers] = useState({
                thane: ['Healer 1', 'Healer 2', 'Healer 3'],
                mograine: ['Healer 4', 'Healer 5', 'Healer 6'],
                zeliek: ['Healer 7', 'Healer 8', 'Healer 9'],
                blaumeux: ['Healer 10', 'Healer 11']
            });

            // Load healers from assignments.json on mount
            useEffect(() => {
                fetch('assignments.json')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to load assignments.json');
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Loaded healers from assignments.json:', data);
                        setHealers(data);
                    })
                    .catch(error => {
                        console.log('Could not load assignments.json, using defaults:', error);
                    });
            }, []);

            const [deadBosses, setDeadBosses] = useState({
                thane: false,
                mograine: false,
                zeliek: false,
                blaumeux: false
            });

            const [newHealerInputs, setNewHealerInputs] = useState({
                thane: '',
                mograine: '',
                zeliek: '',
                blaumeux: ''
            });

            const [currentStack, setCurrentStack] = useState(0);
            const [highlightedHealer, setHighlightedHealer] = useState(null);
            const [animationEnabled, setAnimationEnabled] = useState(true);
            const [healerPositions, setHealerPositions] = useState({});
            const [prevStack, setPrevStack] = useState(0);
            const [isAnimating, setIsAnimating] = useState(false);
            const [initialized, setInitialized] = useState(false);
            
            const gridRef = useRef(null);
            const containerRefs = useRef({});

            // Initialize all healers at mount and when healers change
            useEffect(() => {
                const allHealers = {};
                Object.keys(healers).forEach(boss => {
                    healers[boss].forEach(name => {
                        if (!healerPositions[name]) {
                            allHealers[name] = { x: 0, y: 0, location: boss, data: { healer: name, marks: { thane: 0, blaumeux: 0, zeliek: 0, mograine: 0 }, justMoved: false }};
                        } else {
                            allHealers[name] = healerPositions[name];
                        }
                    });
                });
                
                // Remove healers that no longer exist
                const allHealerNames = Object.keys(healers).flatMap(boss => healers[boss]);
                Object.keys(healerPositions).forEach(name => {
                    if (allHealerNames.includes(name)) {
                        allHealers[name] = healerPositions[name];
                    }
                });
                
                setHealerPositions(allHealers);
                if (!initialized) setInitialized(true);
            }, [healers]);

            const bosses = [
                { id: 'blaumeux', name: 'Lady Blaumeux', position: 'NW', mark: 'Shadow', color: 'bg-purple-600', healerCount: 3 },
                { id: 'zeliek', name: 'Sir Zeliek', position: 'NE', mark: 'Holy', color: 'bg-yellow-500', healerCount: 3 },
                { id: 'thane', name: "Thane Korth'azz", position: 'SW', mark: 'Meteor', color: 'bg-red-600', healerCount: 3 },
                { id: 'mograine', name: 'Highlord Mograine', position: 'SE', mark: 'Righteous Fire', color: 'bg-orange-600', healerCount: 3 }
            ];

            const addHealer = (bossId) => {
                const newName = newHealerInputs[bossId].trim();
                if (newName) {
                    setHealers({
                        ...healers,
                        [bossId]: [...healers[bossId], newName]
                    });
                    setNewHealerInputs({
                        ...newHealerInputs,
                        [bossId]: ''
                    });
                }
            };

            const removeHealer = (bossId, index) => {
                setHealers({
                    ...healers,
                    [bossId]: healers[bossId].filter((_, i) => i !== index)
                });
            };

            const getMarkTime = (stackNum) => {
                if (stackNum === 0) return 0;
                return 20 + (stackNum - 1) * 12;
            };

            const getNextBossInRotation = (currentBoss) => {
                const order = ['thane', 'blaumeux', 'zeliek', 'mograine'];
                const idx = order.indexOf(currentBoss);
                return order[(idx + 1) % 4];
            };

            const getCurrentPositions = (stack) => {
                const positions = { thane: [], blaumeux: [], zeliek: [], mograine: [], safe: [] };
                const currentTime = getMarkTime(stack);

                Object.keys(healers).forEach(startBoss => {
                    healers[startBoss].forEach((healerName, healerIdx) => {
                        const moveStacks = [];
                        for (let s = healerIdx + 1; s <= stack; s += 3) {
                            moveStacks.push(s);
                        }

                        const marks = { thane: 0, blaumeux: 0, zeliek: 0, mograine: 0 };
                        let currentBoss = startBoss;
                        let rotationPos = startBoss;

                        for (let s = 1; s <= stack; s++) {
                            if (moveStacks.includes(s)) {
                                if (currentBoss !== 'safe') {
                                    const timeSince = currentTime - getMarkTime(s);
                                    if (timeSince < 75) marks[currentBoss]++;
                                }
                                const nextBoss = getNextBossInRotation(rotationPos);
                                rotationPos = nextBoss;
                                currentBoss = deadBosses[nextBoss] ? 'safe' : nextBoss;
                            } else {
                                if (currentBoss !== 'safe') {
                                    const timeSince = currentTime - getMarkTime(s);
                                    if (timeSince < 75) marks[currentBoss]++;
                                }
                            }
                        }

                        if (currentBoss !== 'safe' && deadBosses[currentBoss]) {
                            currentBoss = 'safe';
                        }

                        positions[currentBoss].push({
                            healer: healerName,
                            justMoved: moveStacks.includes(stack),
                            marks
                        });
                    });
                });

                return positions;
            };

            const positions = getCurrentPositions(currentStack);

            // Calculate pixel positions for each healer
            useEffect(() => {
                if (!gridRef.current || !initialized) return;

                const gridRect = gridRef.current.getBoundingClientRect();

                setHealerPositions(prev => {
                    const updated = {...prev};

                    // Count healers in safe zone for dynamic spacing
                    const safeZoneCount = positions['safe']?.length || 0;

                    // Get container positions for each location
                    Object.keys(containerRefs.current).forEach(location => {
                        const container = containerRefs.current[location];
                        if (!container) return;

                        const containerRect = container.getBoundingClientRect();
                        
                        if (positions[location]) {
                            positions[location].forEach((healerData, index) => {
                                const locationOffset = {
                                    'blaumeux': 0,
                                    'zeliek': 0.5,
                                    'thane': 1.0,
                                    'mograine': 1.5,
                                    'safe': 2.0
                                };
                                
                                const x = (containerRect.left - gridRect.left) * 1.25 + 10;
                                
                                // Calculate spacing based on actual healer count in safe zone
                                let spacing = 42;
                                if (location === 'safe' && safeZoneCount > 0) {
                                    const availableHeight = containerRect.height * 1.25 - 87.5;
                                    spacing = Math.floor(availableHeight / safeZoneCount);
                                }
                                
                                const y = (containerRect.top - gridRect.top) * 1.25 + 35 + (index * spacing);
                                
                                if (updated[healerData.healer]) {
                                    updated[healerData.healer] = {
                                        ...updated[healerData.healer],
                                        x,
                                        y,
                                        location,
                                        data: healerData,
                                        spacing: spacing
                                    };
                                }
                            });
                        }
                    });

                    return updated;
                });

                // Trigger animation detection
                if (animationEnabled && currentStack !== prevStack) {
                    setIsAnimating(true);
                    setTimeout(() => setIsAnimating(false), 1100);
                    setPrevStack(currentStack);
                }
            }, [currentStack, initialized, healers]);

            // Determine if a healer is currently moving
            const isHealerMoving = (healerName) => {
                if (!isAnimating || !animationEnabled) return false;
                
                const prevPos = getCurrentPositions(prevStack);
                const currPos = getCurrentPositions(currentStack);
                
                let prevLocation = null;
                let currLocation = null;
                
                Object.keys(prevPos).forEach(loc => {
                    if (prevPos[loc].some(h => h.healer === healerName)) {
                        prevLocation = loc;
                    }
                });
                
                Object.keys(currPos).forEach(loc => {
                    if (currPos[loc].some(h => h.healer === healerName)) {
                        currLocation = loc;
                    }
                });
                
                return prevLocation !== currLocation;
            };

            return (
                <div className="min-h-screen bg-indigo-950 text-white p-2 md:p-4 pb-8">
                    <div className="max-w-7xl mx-auto min-h-screen">
                        <div className="text-center mb-4">
                            <h1 className="text-2xl md:text-3xl font-bold mb-1 text-yellow-400">Four Horsemen Healer Rotation</h1>
                        </div>

                        <div className="bg-gray-800 rounded-lg p-3 mb-4 border-2 border-yellow-600">
                            <div className="flex items-center justify-between mb-2">
                                <h2 className="text-lg font-bold text-yellow-400">Visual Timeline</h2>
                                <label className="flex items-center gap-2 cursor-pointer">
                                    <span className="text-sm font-medium">Animations</span>
                                    <button
                                        onClick={() => setAnimationEnabled(!animationEnabled)}
                                        className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${animationEnabled ? 'bg-blue-600' : 'bg-gray-600'}`}
                                    >
                                        <span className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${animationEnabled ? 'translate-x-6' : 'translate-x-1'}`} />
                                    </button>
                                </label>
                            </div>
                            <div className="flex items-center gap-4 mb-2">
                                <label className="font-bold text-sm">Current Stack:</label>
                                <input
                                    type="range"
                                    min="0"
                                    max="30"
                                    value={currentStack}
                                    onChange={(e) => setCurrentStack(parseInt(e.target.value))}
                                    className="flex-1 h-2 bg-gray-700 rounded-lg cursor-pointer"
                                />
                                <span className="text-xl font-bold text-yellow-400 w-10 text-center">{currentStack}</span>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => setCurrentStack(Math.max(0, currentStack - 1))} className="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded text-sm">← Previous</button>
                                <button onClick={() => setCurrentStack(0)} className="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm">Reset</button>
                                <button onClick={() => setCurrentStack(Math.min(30, currentStack + 1))} className="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded text-sm">Next →</button>
                            </div>
                        </div>

                        <div className="grid lg:grid-cols-3 gap-4 mb-4" style={{overflow: 'visible'}}>
                            <div className="lg:col-span-2 flex flex-col" style={{overflow: 'visible'}}>
                                <div className="bg-gray-800 rounded-lg p-3 pb-6 border-2 border-purple-600 mb-2" style={{overflow: 'visible'}}>
                                    <h2 className="text-base font-bold mb-2 text-center text-purple-400">Room Layout - Stack {currentStack}</h2>
                                    <div className="relative grid-container" style={{paddingBottom: '80%', overflow: 'visible'}} ref={gridRef}>
                                        {/* Static grid background */}
                                        <div className="absolute inset-0 grid grid-cols-3 gap-2 pointer-events-none" style={{zIndex: 1, gridTemplateRows: '28% 44% 28%'}}>
                                            {[
                                                { boss: bosses.find(b => b.id === 'blaumeux'), id: 'blaumeux', pos: 0 },
                                                { boss: null, pos: 1 },
                                                { boss: bosses.find(b => b.id === 'zeliek'), id: 'zeliek', pos: 2 },
                                                { boss: null, pos: 3 },
                                                { boss: 'safe', id: 'safe', pos: 4 },
                                                { boss: null, pos: 5 },
                                                { boss: bosses.find(b => b.id === 'thane'), id: 'thane', pos: 6 },
                                                { boss: null, pos: 7 },
                                                { boss: bosses.find(b => b.id === 'mograine'), id: 'mograine', pos: 8 }
                                            ].map((cell, idx) => {
                                                if (!cell.boss) return <div key={idx} className="border-2 border-dashed border-gray-600 rounded" />;
                                                if (cell.boss === 'safe') {
                                                    return (
                                                        <div key={idx} ref={el => containerRefs.current['safe'] = el} className="bg-green-900 bg-opacity-40 rounded-lg p-4 border-4 border-green-500 overflow-hidden">
                                                            <div className="text-center text-xs font-bold mb-1 text-green-400">SAFE ZONE</div>
                                                        </div>
                                                    );
                                                }
                                                return (
                                                    <div key={idx} ref={el => containerRefs.current[cell.id] = el} className={`${cell.boss.color} rounded-lg p-4 border-2 ${deadBosses[cell.boss.id] ? 'opacity-40 border-red-500' : 'border-gray-700'} relative`}>
                                                        <button onClick={() => setDeadBosses({ ...deadBosses, [cell.boss.id]: !deadBosses[cell.boss.id] })} className={`absolute top-1 right-1 p-0.5 rounded text-sm ${deadBosses[cell.boss.id] ? 'bg-red-700' : 'bg-gray-800'} hover:bg-gray-700 pointer-events-auto`} style={{zIndex: 5}}>☠</button>
                                                        <div className="text-center text-xs font-bold mb-1 text-white">{cell.boss.position} - {cell.boss.name}</div>
                                                    </div>
                                                );
                                            })}
                                        </div>

                                        {/* Animated healer cards */}
                                        {Object.keys(healers).flatMap(startBoss => 
                                            healers[startBoss].map((healerName) => {
                                                const posData = healerPositions[healerName];
                                                if (!posData) return null;
                                                
                                                const h = posData.data;
                                                const moving = isHealerMoving(h.healer);
                                                const safeZoneHealerCount = positions['safe']?.length || 0;
                                                const isInSafeZone = posData.location === 'safe';
                                                
                                                // Scale down text based on number in safe zone
                                                let nameSize = 'text-[11px]';
                                                let statSize = 'text-[9px]';
                                                let padding = 'py-1';
                                                
                                                if (isInSafeZone) {
                                                    if (safeZoneHealerCount >= 8) {
                                                        nameSize = 'text-[9px]';
                                                        statSize = 'text-[8px]';
                                                        padding = 'py-0.5';
                                                    } else if (safeZoneHealerCount >= 6) {
                                                        nameSize = 'text-[10px]';
                                                        statSize = 'text-[8px]';
                                                        padding = 'py-0.5';
                                                    }
                                                }
                                                
                                                return (
                                                    <div
                                                        key={healerName}
                                                        className={`healer-card ${!animationEnabled ? 'no-animation' : ''} ${moving ? 'moving' : ''}`}
                                                        style={{
                                                            left: `${posData.x}px`,
                                                            top: `${posData.y}px`,
                                                            width: 'calc(33.333% - 20px)',
                                                        }}
                                                    >
                                                        <div className={`text-xs bg-gray-900 bg-opacity-90 rounded px-2 py-1 ${h.justMoved ? 'ring-2 ring-yellow-400 animate-pulse' : ''} ${h.healer === highlightedHealer ? 'ring-4 ring-blue-400' : ''}`}>
                                                            <div className="font-semibold mb-1 text-white">{h.healer}</div>
                                                            <div className="flex gap-2 text-[11px] flex-wrap font-medium">
                                                                <span className="text-red-400">T:{h.marks.thane}</span>
                                                                <span className="text-purple-400">B:{h.marks.blaumeux}</span>
                                                                <span className="text-yellow-400">Z:{h.marks.zeliek}</span>
                                                                <span className="text-orange-400">M:{h.marks.mograine}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })
                                        )}
                                    </div>
                                </div>

                                <div className="bg-gray-800 rounded-lg p-3 border-2 border-yellow-600 flex-1">
                                    <h2 className="text-lg font-bold mb-2 text-yellow-400">Rotation Rules</h2>
                                    <div className="text-sm mb-2"><span className="font-bold">Movement Path:</span> Thane → Blaumeux → Zeliek → Mograine → (repeat)</div>
                                    <div className="grid md:grid-cols-2 gap-2 text-xs">
                                        <div className="bg-gray-700 rounded p-2">
                                            <h3 className="font-bold mb-1 text-purple-400 text-xs">Initial Rotations:</h3>
                                            <ul className="space-y-0.5 text-gray-300">
                                                <li>• <span className="font-bold">1st Healer:</span> Moves at 1 stack</li>
                                                <li>• <span className="font-bold">2nd Healer:</span> Moves at 2 stacks</li>
                                                <li>• <span className="font-bold">3rd Healer:</span> Moves at 3 stacks</li>
                                            </ul>
                                        </div>
                                        <div className="bg-gray-700 rounded p-2">
                                            <h3 className="font-bold mb-1 text-purple-400 text-xs">Ongoing Rotations:</h3>
                                            <ul className="space-y-0.5 text-gray-300">
                                                <li>• After initial: move every 3 stacks (4, 7, 10, 13...)</li>
                                                <li>• If next boss is dead → go to Safe Zone</li>
                                                <li>• Yellow highlight = healer just moved</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 gap-2">
                                {bosses.map((boss) => (
                                    <div key={boss.id} className={`${boss.color} rounded-lg p-3 border-2 border-gray-700`}>
                                        <h3 className="text-sm font-bold mb-2">{boss.name} ({boss.position})</h3>
                                        
                                        <div className="space-y-1 mb-2">
                                            <div className="text-xs font-bold">Assigned Healers ({healers[boss.id].length}/{boss.healerCount}):</div>
                                            {healers[boss.id].map((healer, index) => (
                                                <div key={index} className="flex items-center justify-between bg-black bg-opacity-30 rounded px-2 py-1">
                                                    <div className="flex items-center gap-2 flex-1">
                                                        <button
                                                            onClick={() => setHighlightedHealer(highlightedHealer === healer ? null : healer)}
                                                            className={`px-1.5 py-0.5 rounded text-xs font-bold transition-colors ${highlightedHealer === healer ? 'bg-blue-500 text-white' : 'bg-gray-700 text-gray-300 hover:bg-blue-600'} ${highlightedHealer && highlightedHealer !== healer ? 'invisible' : ''}`}
                                                            title={highlightedHealer === healer ? 'Remove highlight' : 'Highlight this healer'}
                                                        >
                                                            ME
                                                        </button>
                                                        <span className="font-medium text-xs">{index + 1}. {healer}</span>
                                                    </div>
                                                    <button
                                                        onClick={() => removeHealer(boss.id, index)}
                                                        className="text-red-400 hover:text-red-300"
                                                    >
                                                        ✕
                                                    </button>
                                                </div>
                                            ))}
                                        </div>

                                        <div className="flex gap-2">
                                            <input
                                                type="text"
                                                value={newHealerInputs[boss.id]}
                                                onChange={(e) => setNewHealerInputs({...newHealerInputs, [boss.id]: e.target.value})}
                                                onKeyPress={(e) => e.key === 'Enter' && addHealer(boss.id)}
                                                placeholder="Add healer..."
                                                className="flex-1 bg-black bg-opacity-30 border border-gray-600 rounded px-2 py-1 text-xs focus:outline-none focus:border-white"
                                            />
                                            <button
                                                onClick={() => addHealer(boss.id)}
                                                className="bg-black bg-opacity-30 hover:bg-opacity-50 px-2 py-1 rounded transition-colors text-sm"
                                            >
                                                +
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<FourHorsemenRotation />, document.getElementById('root'));
    </script>
</body>
</html>